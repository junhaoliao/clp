version: "3"

includes:
  toolchains: "../toolchains.yaml"

tasks:
  check-rust:
    cmds:
      - task: "cargo-workspace-fetch"
        vars:
          CARGO_FETCH_FLAGS: "--locked"

  check-uv:
    cmds:
      - for: &uv-component-projects
          - "clp-mcp-server"
          - "clp-package-utils"
          - "clp-py-utils"
          - "job-orchestration"
        cmd: |-
          uv lock --directory "{{default (cat .ROOT_DIR "/components") .G_COMPONENTS_DIR}}/{{.ITEM}}" --check
      - for: &uv-root-projects
          - "integration-tests"
          - "tools/yscope-dev-utils/exports/ystdlib-py"
        cmd: |-
          uv lock --directory "{{.ROOT_DIR}}/{{.ITEM}}" --check

  update-rust:
    cmds:
      - task: "cargo-workspace-update"
        vars:
          CARGO_UPDATE_FLAGS: ""

  update-uv:
    cmds:
      - for: *uv-component-projects
        cmd: |-
          uv lock --directory "{{default (cat .ROOT_DIR "/components") .G_COMPONENTS_DIR}}/{{.ITEM}}"
      - for: *uv-root-projects
        cmd: |-
          uv lock --directory "{{.ROOT_DIR}}/{{.ITEM}}"

  # Runs `cargo fetch` in the root Rust workspace directory with the specified flags.
  #
  # @param {string} CARGO_FETCH_FLAGS The flags to pass to the `cargo fetch` command.
  cargo-workspace-fetch:
    internal: true
    requires:
      vars: ["CARGO_FETCH_FLAGS"]
    dir: "{{.ROOT_DIR}}"
    deps: ["toolchains:rust"]
    cmd: |-
      . "$HOME/.cargo/env"
      cargo fetch {{.CARGO_FETCH_FLAGS}}

  # Runs `cargo update` in the root Rust workspace directory with the specified flags.
  #
  # @param {string} CARGO_UPDATE_FLAGS The flags to pass to the `cargo update` command.
  cargo-workspace-update:
    internal: true
    requires:
      vars: ["CARGO_UPDATE_FLAGS"]
    dir: "{{.ROOT_DIR}}"
    deps: ["toolchains:rust"]
    cmd: |-
      . "$HOME/.cargo/env"
      cargo update {{.CARGO_UPDATE_FLAGS}}
